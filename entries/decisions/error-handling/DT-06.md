# DT-06.md

**REF-ID:** DT-06  
**Category:** Decision Logic  
**Subcategory:** Error Handling  
**Name:** What Exception Type to Raise  
**Priority:** Medium  
**Status:** Active  
**Created:** 2024-10-30  
**Updated:** 2024-10-30

---

## Summary

Decision tree for selecting appropriate exception types - choosing between built-in Python exceptions vs custom exceptions based on error semantics.

---

## Problem

Python provides many built-in exception types. Choosing the correct exception type makes error handling clearer and more maintainable. Custom exceptions should only be used when built-ins don't fit.

---

## Decision Tree

```
START: Need to raise exception
│
├─ Q: Is it invalid input/argument?
│  └─ YES → ValueError
│         Example: Invalid email format, negative value where positive required
│         raise ValueError(f"Expected positive value, got {value}")
│
├─ Q: Is it missing key/attribute?
│  └─ YES → KeyError or AttributeError
│         KeyError: Missing dict key
│         AttributeError: Missing object attribute
│         raise KeyError(f"Required key '{key}' not found")
│
├─ Q: Is it wrong type?
│  └─ YES → TypeError
│         Example: Expected string, got int
│         raise TypeError(f"Expected str, got {type(value)}")
│
├─ Q: Is it index out of range?
│  └─ YES → IndexError
│         Example: List index beyond length
│         raise IndexError(f"Index {idx} out of range for list length {len(items)}")
│
├─ Q: Is it not implemented/supported?
│  └─ YES → NotImplementedError
│         Example: Abstract method, future feature
│         raise NotImplementedError("Subclasses must implement this method")
│
├─ Q: Is it runtime/operational error?
│  └─ YES → RuntimeError or custom domain exception
│         RuntimeError: Generic runtime issue
│         Custom: Domain-specific semantics
│         raise RuntimeError("Operation failed in unexpected way")
│
└─ Q: Is it domain-specific with unique handling?
   └─ YES → Custom exception
          Example: CacheOperationError, AuthenticationError
          raise CacheOperationError("Cache operation failed")
```

---

## Exception Type Guide

### ValueError
**Use when:** Invalid value for correct type
```python
def set_age(age: int):
    if age < 0:
        raise ValueError(f"Age must be positive, got {age}")
    if age > 150:
        raise ValueError(f"Age unrealistic: {age}")
```

### TypeError
**Use when:** Wrong type provided
```python
def process_string(text: str):
    if not isinstance(text, str):
        raise TypeError(f"Expected str, got {type(text).__name__}")
```

### KeyError
**Use when:** Missing dictionary key
```python
def get_config_value(key: str) -> str:
    if key not in CONFIG:
        raise KeyError(f"Config key not found: {key}")
    return CONFIG[key]
```

### AttributeError
**Use when:** Missing object attribute
```python
def get_user_email(user):
    if not hasattr(user, 'email'):
        raise AttributeError(f"User object missing 'email' attribute")
    return user.email
```

### IndexError
**Use when:** Invalid index access
```python
def get_item(items: list, index: int):
    if index < 0 or index >= len(items):
        raise IndexError(f"Index {index} out of range [0, {len(items)})")
    return items[index]
```

### NotImplementedError
**Use when:** Feature not implemented
```python
class BaseInterface:
    def process(self, data):
        raise NotImplementedError("Subclasses must implement process()")
```

### RuntimeError
**Use when:** Generic runtime issue
```python
def perform_operation():
    if system_not_ready():
        raise RuntimeError("System not initialized")
```

---

## Custom Exception Guidelines

### When to Create Custom Exception

**Create custom exception when:**
1. Specific domain semantics needed
2. Unique handling required
3. Multiple related error types
4. Clear error hierarchy needed

**Example - Cache Operations:**
```python
class CacheError(Exception):
    """Base exception for cache operations."""
    pass

class CacheConnectionError(CacheError):
    """Cache connection failed."""
    pass

class CacheKeyError(CacheError):
    """Invalid cache key."""
    pass

# Usage
try:
    cache_operation()
except CacheError as e:  # Catches all cache-related errors
    handle_cache_error(e)
```

### When NOT to Create Custom Exception

**Use built-ins when:**
1. Standard Python semantics apply
2. No special handling needed
3. Error is generic/common

**Don't do this:**
```python
# ❌ Unnecessary custom exception
class InvalidValueError(Exception):
    pass

# ✅ Use built-in instead
raise ValueError("Invalid value")
```

---

## Examples by Scenario

### Scenario 1: Validation Error

**Context:** Function receives invalid input

**Built-in Choice: ValueError**
```python
def cache_set(key: str, value: Any, ttl: int = 300):
    """Set cache value with validation."""
    if not key:
        raise ValueError("Cache key cannot be empty")
    if not isinstance(key, str):
        raise TypeError(f"Key must be str, got {type(key)}")
    if ttl < 0:
        raise ValueError(f"TTL must be positive, got {ttl}")
    
    _set_to_cache(key, value, ttl)
```

### Scenario 2: Missing Configuration

**Context:** Required config key not found

**Built-in Choice: KeyError**
```python
from gateway import get_config

def initialize_service():
    """Initialize service with required config."""
    try:
        api_key = get_config('API_KEY')
        endpoint = get_config('API_ENDPOINT')
    except KeyError as e:
        raise KeyError(f"Missing required configuration: {e}")
    
    return Service(api_key, endpoint)
```

### Scenario 3: Domain-Specific Error

**Context:** Cache operation failure with specific handling

**Custom Exception:**
```python
class CacheOperationError(Exception):
    """Cache-specific error with metadata."""
    def __init__(self, message: str, operation: str, key: str):
        super().__init__(message)
        self.operation = operation
        self.key = key

# Usage
def cache_operation(key: str):
    try:
        perform_cache_op(key)
    except Exception as e:
        raise CacheOperationError(
            f"Cache operation failed: {e}",
            operation='set',
            key=key
        )

# Handling
try:
    cache_operation('my_key')
except CacheOperationError as e:
    log_error(
        f"Cache {e.operation} failed for key {e.key}",
        error=e
    )
```

---

## Exception Hierarchy Example

```python
# Good exception hierarchy
class ServiceError(Exception):
    """Base exception for service."""
    pass

class ServiceConnectionError(ServiceError):
    """Connection to service failed."""
    pass

class ServiceTimeoutError(ServiceError):
    """Service request timed out."""
    pass

class ServiceAuthError(ServiceError):
    """Authentication with service failed."""
    pass

# Usage - catch all service errors
try:
    service_call()
except ServiceError as e:
    # Handles all service-related errors
    handle_service_error(e)

# Or catch specific
try:
    service_call()
except ServiceAuthError:
    refresh_credentials()
except ServiceTimeoutError:
    retry_with_backoff()
```

---

## Anti-Patterns

### ❌ Wrong Exception Type

**Problem:**
```python
def get_user(user_id: str):
    if user_id not in users:
        raise ValueError("User not found")  # Wrong! This is KeyError
```

**Solution:**
```python
def get_user(user_id: str):
    if user_id not in users:
        raise KeyError(f"User not found: {user_id}")  # Correct
```

### ❌ Unnecessary Custom Exception

**Problem:**
```python
class EmptyStringError(Exception):
    pass

if not text:
    raise EmptyStringError("String is empty")
```

**Solution:**
```python
if not text:
    raise ValueError("String cannot be empty")  # Use built-in
```

---

## Related Patterns

**From NM05 (Anti-Patterns):**
- **AP-14:** Bare except clauses
- **AP-15:** Swallowing exceptions
- **AP-16:** No error context

**From NM07 (Decision Logic):**
- **DT-05:** How to handle errors

---

## Keywords

exception types, raise exception, ValueError, KeyError, TypeError, custom exceptions, error types

---

## Version History

- **2024-10-30:** Migrated to SIMAv4 format from NM07 v3
- **2024-10-24:** Created in SIMAv3 format

---

**File:** `DT-06.md`  
**Location:** `/sima/entries/decisions/error-handling/`  
**End of Document**
