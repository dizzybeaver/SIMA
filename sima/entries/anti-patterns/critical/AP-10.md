# File: AP-10.md

**REF-ID:** AP-10  
**Version:** 1.0.0  
**Category:** Anti-Patterns  
**Type:** Critical  
**Severity:** üî¥ Critical  
**Status:** Active

---

## SUMMARY

Using mutable default arguments in Python functions. This is a classic Python gotcha that causes shared state bugs.

---

## THE ANTI-PATTERN

```python
# ‚ùå MUTABLE DEFAULT ARGUMENT
def add_item(item, items=[]):  # DANGER!
    items.append(item)
    return items

# Usage
list1 = add_item("a")  # ["a"]
list2 = add_item("b")  # ["a", "b"] - UNEXPECTED!
list3 = add_item("c")  # ["a", "b", "c"] - BUG!
```

---

## WHY IT'S WRONG

**Default Created Once:**
- Default list created at function definition
- Same list object reused for all calls
- Modifications persist across calls
- Subtle, hard-to-find bugs

**BUG-01 Incident:**
Sentinel object (_CacheMiss) was passed as default, causing 535ms performance penalty.

---

## WHAT TO DO INSTEAD

```python
# ‚úÖ USE None AS DEFAULT
def add_item(item, items=None):
    if items is None:
        items = []
    items.append(item)
    return items

# Usage
list1 = add_item("a")  # ["a"]
list2 = add_item("b")  # ["b"] - CORRECT!
list3 = add_item("c")  # ["c"] - CORRECT!
```

---

## APPLIES TO

**Any Mutable Type:**
- Lists: `[]`
- Dicts: `{}`
- Sets: `set()`
- Custom objects
- Sentinel objects (BUG-01)

**Safe Immutables:**
- None (preferred)
- Numbers: `0`, `1`
- Strings: `""`
- Tuples: `()`

---

## DETECTION

```python
# Lint rule
def check_defaults(func):
    defaults = func.__defaults__
    if defaults:
        for d in defaults:
            if isinstance(d, (list, dict, set)):
                raise Warning(f"Mutable default in {func.__name__}")
```

---

## REAL-WORLD INCIDENT

**BUG-01:** _CacheMiss sentinel used as default argument
- Performance: 535ms penalty
- Cause: Mutable default
- Fix: DEC-05 (Sentinel sanitization)

---

## RELATED

- **BUG-01** - Sentinel Leak
- **DEC-05** - Sentinel Sanitization
- **AP-19** - Sentinel Crossing Boundaries

---

**Keywords:** mutable defaults, Python gotcha, shared state, default arguments

---

**END OF AP-10**
