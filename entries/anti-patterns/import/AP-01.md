# File: AP-01.md

**REF-ID:** AP-01  
**Version:** 1.0.0  
**Category:** Anti-Patterns  
**Type:** Import Violations  
**Severity:** ðŸ"´ Critical  
**Status:** Active

---

## SUMMARY

Importing core modules directly across interface boundaries instead of using the gateway pattern. This is the most fundamental architectural violation in SUGA-based systems.

---

## THE ANTI-PATTERN

### What NOT to Do

```python
# âŒ WRONG - Direct cross-interface import
from cache_core import get_value, set_value
from logging_core import log_message, log_error
from security_core import hash_data

def process_request(data):
    cached = get_value("key")
    log_message("Processing...")
    hashed = hash_data(data)
    return hashed
```

### Why It's Bad

1. **Violates SUGA Architecture** - Breaks the gateway pattern that prevents circular dependencies
2. **Circular Import Risk** - Direct imports create dependency webs causing import loops
3. **No Central Control** - Gateway provides unified error handling and metrics
4. **Maintenance Nightmare** - Changes require updating all direct importers
5. **Testing Difficulty** - Cannot mock at gateway level

---

## WHAT TO DO INSTEAD

### Correct Approach

```python
# âœ… CORRECT - Import via gateway
import gateway

def process_request(data):
    cached = gateway.cache_get("key")
    gateway.log_info("Processing...")
    hashed = gateway.security_hash(data)
    return hashed
```

### Why This Is Better

- Single import statement for all operations
- Gateway handles error cases uniformly
- Easy to mock for testing (mock `gateway`)
- Prevents circular dependencies by design
- Consistent interface across entire codebase

---

## REAL-WORLD EXAMPLE

### Context

Early development before SUGA pattern was established.

### Problem Code

```python
# In http_client_core.py
from cache_core import get_value
from logging_core import log_error

def make_request(url):
    cached = get_value(url)
    if cached:
        return cached
    # Make request...
```

### What Went Wrong

- Created circular dependency: http â†' cache â†' logging â†' http
- Import errors during initialization
- 2 hours of debugging time

### Solution

```python
# In http_client_core.py
import gateway

def make_request(url):
    cached = gateway.cache_get(url)
    if cached:
        return cached
    # Make request...
```

### Result

- No circular dependencies
- Clean initialization order
- Code works immediately

---

## HOW TO IDENTIFY

### Code Smells

- `from *_core import` statements across interface boundaries
- Multiple core module imports in a single file
- Import errors during module loading
- "Partially initialized module" errors

### Detection

```bash
# Find direct cross-interface imports
grep -r "from .*_core import" *.py | grep -v "# Intra-interface"

# Should return zero results (except within same interface)
```

---

## EXCEPTION: INTRA-INTERFACE IMPORTS

### Important Distinction

```python
# âœ… ALLOWED - Within same interface
# In cache_helper.py (part of CACHE interface)
from cache_core import _get_cache_store  # Same interface, OK

# âŒ NOT ALLOWED - Across interfaces  
# In http_client_core.py (HTTP interface)
from cache_core import get_value  # Different interface, use gateway!
```

### Rule

Direct imports allowed ONLY within the same interface (same functional domain).

---

## IMPACT ANALYSIS

### Performance Impact

```
Gateway overhead: ~100ns per call
Typical operation: 1-100ms
Overhead percentage: 0.01% - 0.0001% (negligible)

Trade-off: 100ns overhead vs architectural integrity
Conclusion: Gateway overhead is negligible
```

### Maintenance Impact

```
Without gateway:
- Update 1 interface = Update N importers
- Add error handling = Update all call sites
- Testing = Mock N×M combinations

With gateway:
- Update 1 interface = Gateway adapts automatically
- Add error handling = Once at gateway level
- Testing = Mock once at gateway
```

---

## RELATED PATTERNS

### Must Read First
- **ARCH-01** - SUGA Pattern (foundation)
- **DEC-01** - SUGA Pattern Decision (why we chose this)
- **DEC-02** - Gateway Centralization (architectural decision)

### Related Rules
- **GATE-01** - Three-File Structure
- **GATE-03** - Cross-Interface Communication

### Related Anti-Patterns
- **AP-02** - Importing Interface Routers
- **AP-04** - Circular Imports via Gateway

### Related Bugs
- **BUG-02** - Circular Import Crash (caused by violating this)

---

## DETECTION AND PREVENTION

### Code Review Checklist

- [ ] All cross-interface operations use `import gateway`
- [ ] No direct core-to-core imports
- [ ] Intra-interface imports are direct (not through gateway)
- [ ] No import errors when testing

### Automated Detection

```python
# Lint rule example
def check_imports(file_path):
    interface = get_interface_name(file_path)
    for import_line in get_imports(file_path):
        if 'from' in import_line and '_core import' in import_line:
            imported_interface = extract_interface(import_line)
            if imported_interface != interface:
                raise LintError(f"AP-01 violation: {import_line}")
```

---

## MIGRATION GUIDE

### If You Find This Pattern

**Step 1:** Identify the cross-interface import
```python
from logging_core import log_info  # âŒ Found it!
```

**Step 2:** Replace with gateway
```python
import gateway  # âœ… Add this
```

**Step 3:** Update function calls
```python
log_info("message")  # âŒ Old way
gateway.log_info("message")  # âœ… New way
```

**Step 4:** Test
```bash
python -m pytest tests/test_your_module.py
```

**Step 5:** Verify no circular imports
```bash
python -c "import your_module"  # Should work without errors
```

---

## SEVERITY JUSTIFICATION

### Why Critical

1. **Breaks Architecture** - Violates core design principle
2. **Production Impact** - Can cause complete system failure
3. **Cascading Issues** - Creates web of dependencies
4. **Hard to Fix** - Requires architectural refactoring
5. **Common Mistake** - Easy to introduce accidentally

### Incident History

- **2025-10-18:** Circular import crash in production
- **2025-09-12:** 2-hour debugging session
- **2025-08-05:** Import error prevented deployment

**Total incidents:** 7 over 3 months  
**MTTR:** 45 minutes average  
**Prevention:** 100% with gateway pattern

---

## KEYWORDS

direct imports, cross-interface, circular dependencies, gateway pattern, SUGA violation, architecture, import errors

---

## VERSION HISTORY

### [1.0.0] - 2025-10-30
- Migrated to SIMAv4 format
- Added performance impact data
- Added migration guide
- Enhanced detection methods

### [0.9.0] - 2025-10-23
- SIMA v3 individual file format

### [0.1.0] - 2024-10-15
- Initial documentation

---

**END OF ANTI-PATTERN ENTRY**

**Related:** AP-02, AP-04, ARCH-01, DEC-01, GATE-01, GATE-03, BUG-02
