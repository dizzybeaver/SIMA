# DT-12.md

**REF-ID:** DT-12  
**Category:** Decision Logic  
**Subcategory:** Deployment  
**Name:** Should I Deploy This Change  
**Priority:** High  
**Status:** Active  
**Created:** 2024-10-30  
**Updated:** 2024-10-30

---

## Summary

Decision tree for deployment decisions with comprehensive checklist ensuring changes are tested, reviewed, backward compatible, and have rollback plans before production deployment.

---

## Problem

Deploying to production carries risk of breaking existing functionality or causing downtime. Teams need systematic validation process balancing deployment speed with safety requirements.

---

## Decision Tree

```
START: Change ready to deploy
│
├─ MUST: Are tests passing?
│  ├─ NO → Fix tests first
│  │      Don't deploy with failing tests
│  │      → STOP
│  │
│  └─ YES → Continue
│
├─ MUST: Is change reviewed?
│  ├─ NO → Get review
│  │      All changes need review
│  │      → STOP
│  │
│  └─ YES → Continue
│
├─ SHOULD: Is change backward compatible?
│  ├─ NO → Plan migration
│  │      Document breaking changes
│  │      Coordinate with users
│  │      → Continue with caution
│  │
│  └─ YES → Continue
│
├─ SHOULD: Can change be rolled back?
│  ├─ NO → Add rollback plan
│  │      Git tag, backup, migration scripts
│  │      → Continue
│  │
│  └─ YES → Continue
│
├─ Q: What is risk level?
│  │
│  ├─ HIGH/CRITICAL → Deploy to staging
│  │      Test thoroughly in staging
│  │      Load test if needed
│  │      → Then deploy to prod
│  │
│  └─ LOW/MEDIUM → Deploy directly to prod
│         Monitor closely
│         → DEPLOY
│
└─ DEPLOY
   Steps:
   1. Git tag release (v1.2.3)
   2. Deploy code
   3. Monitor logs (real-time)
   4. Verify functionality
   5. Watch metrics (30 min)
   6. Document deployment
   → END
```

---

## Examples

### Example 1: Low Risk - Simple Bug Fix

**Scenario:** Fix cache key validation bug

**Pre-Deployment:**
```
Change: Fix cache key validation regex
Tests: âœ… All passing (unit + integration)
Review: âœ… Approved by team lead
Backward Compat: âœ… Yes (stricter validation)
Rollback: âœ… Simple git revert
Risk: LOW
```

**Deployment:**
```
1. âœ… Tests passing
2. âœ… Review complete
3. âœ… Backward compatible
4. âœ… Rollback ready
5. âœ… Deploy directly to prod
6. âœ… Monitor for 30 minutes
7. âœ… Verify caching works
8. âœ… Document in changelog
```

**Result:** Safe, quick deployment

### Example 2: Medium Risk - New Feature

**Scenario:** Add new API endpoint for device status

**Pre-Deployment:**
```
Change: New `/status` endpoint
Tests: âœ… All passing (unit + integration + E2E)
Review: âœ… Approved with suggestions applied
Backward Compat: âœ… Yes (additive only)
Rollback: âœ… Feature flag + git revert
Risk: MEDIUM
Staging: âœ… Yes (test first)
```

**Deployment:**
```
1. âœ… Deploy to staging
2. âœ… Test new endpoint in staging
3. âœ… Verify existing endpoints unaffected
4. âœ… Tests passing
5. âœ… Review complete
6. âœ… Deploy to prod
7. âœ… Monitor logs closely (1 hour)
8. âœ… Test new endpoint in prod
9. âœ… Watch error rates
10. âœ… Document new endpoint
```

**Result:** Staged deployment, thorough validation

### Example 3: High Risk - Architecture Change

**Scenario:** Refactor gateway import pattern

**Pre-Deployment:**
```
Change: Modify gateway.py and 20+ files
Tests: âœ… All passing (100+ tests)
Review: âœ… Multiple reviewers approved
Backward Compat: âš ï¸ Breaking (import paths change)
Rollback: âœ… Full backup + git tag
Risk: HIGH
Staging: âœ… REQUIRED
Load Test: âœ… REQUIRED
Migration: âœ… Documented migration plan
```

**Deployment:**
```
1. âœ… Deploy to staging
2. âœ… Run full test suite in staging
3. âœ… Load test (simulate production traffic)
4. âœ… Test for 48 hours in staging
5. âœ… Document migration steps
6. âœ… Notify team of deployment window
7. âœ… Create rollback script
8. âœ… Deploy to prod during low-traffic window
9. âœ… Monitor extensively (4 hours minimum)
10. âœ… Run smoke tests
11. âœ… Verify all interfaces working
12. âœ… Watch metrics for 24 hours
```

**Result:** Careful, phased deployment with extensive validation

### Example 4: Don't Deploy - Tests Failing

**Scenario:** Feature ready but 2 tests failing

**Status:**
```
Change: New caching feature
Tests: ❌ 2 integration tests failing
Review: âœ… Approved
Backward Compat: âœ… Yes
Rollback: âœ… Ready
```

**Decision:** **DON'T DEPLOY**

**Actions:**
```
1. ❌ STOP - Tests must pass
2. Investigate failing tests
3. Fix issues causing failures
4. Re-run full test suite
5. Get tests to âœ… pass
6. THEN consider deployment
```

**Rationale:** Never deploy with failing tests

### Example 5: Critical Risk - Breaking API Change

**Scenario:** Change response format for compatibility

**Pre-Deployment:**
```
Change: Modify API response structure
Tests: âœ… All passing (including migration tests)
Review: âœ… Approved by architecture team
Backward Compat: ❌ BREAKING CHANGE
Rollback: âœ… Migration scripts both directions
Risk: CRITICAL
Staging: âœ… Required + extended testing
Migration: âœ… Phased rollout plan
Communication: âœ… Users notified 1 week ahead
```

**Deployment:**
```
1. âœ… Notify all users (1 week notice)
2. âœ… Deploy v1 + v2 endpoints to staging
3. âœ… Test backward compat shim
4. âœ… Load test both versions
5. âœ… Document migration guide
6. âœ… Stage for 1 week
7. âœ… Deploy v2 to prod (both endpoints live)
8. âœ… Monitor v1 usage metrics
9. âœ… Gradual migration over 2 weeks
10. âœ… Deprecate v1 after confirmed v2 adoption
11. âœ… Remove v1 after deprecation period
```

**Result:** Phased migration minimizing user impact

---

## Related Patterns

**Decision Logic:**
- **DT-08**: What Should I Test (testing before deployment)
- **DT-10**: Should I Refactor This Code (refactoring risks)

**Anti-Patterns:**
- **AP-27**: Skipping Verification Protocol (deployment anti-pattern)
- **AP-28**: Deploy Without Testing (dangerous practice)

**Lessons:**
- **LESS-09**: Deployment Checklist (operational lessons)
- **LESS-19**: Production Monitoring (post-deployment)

**Decisions:**
- **DEC-21**: Deployment Strategy (deployment patterns)
- **DEC-22**: Rollback Procedures (how to rollback)

---

## Keywords

deployment decision, production deployment, deployment checklist, risk assessment, staging environment, rollback plan, deployment strategy, code review, test passing, backward compatibility

---

## Version History

- **2024-10-30:** Migrated to SIMAv4 format from NM07 v3
- **2024-10-24:** Created in SIMAv3 format

---

**File:** `DT-12.md`  
**Location:** `/sima/entries/decisions/deployment/`  
**End of Document**
