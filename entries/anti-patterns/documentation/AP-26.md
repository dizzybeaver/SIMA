# AP-26.md - Stale Comments

**REF-ID:** AP-26  
**Version:** 1.0.0  
**Category:** Anti-Patterns  
**Topic:** Documentation  
**Priority:** 🟡 MEDIUM  
**Status:** Active  
**Created:** 2025-10-30  
**Last Updated:** 2025-10-30

---

## Summary

Comments that contradict the code, becoming outdated as code evolves. Stale comments are worse than no comments—they actively mislead developers and create confusion.

---

## Context

Code changes frequently but comments don't always get updated. As code and comments diverge, comments become lies that waste time and cause bugs.

**Problem:** Misleading information, wasted debugging time, dangerous assumptions, lost trust in documentation.

---

## Content

### The Anti-Pattern

```python
# ❌ STALE COMMENTS - Code and comments diverge

# Returns list of active users
def get_users():
    # Code was refactored - now returns dict!
    return {"users": [...], "count": 10, "page": 1}

# Cached for 5 minutes
CACHE_TTL = 600  # Actually 10 minutes (600 seconds)

# Validates email format
def validate_input(data):
    # Now validates email AND phone!
    check_email(data['email'])
    check_phone(data['phone'])  # Added later
```

### Why This Is Dangerous

**1. Misleads Developers**
```python
# Developer reads comment
# Writes code based on comment
# Comment is wrong
# Code breaks

# Comment says: Returns list
users = get_users()
for user in users:  # TypeError: dict not iterable
    process(user)
```

**2. Wastes Debugging Time**
```python
# Bug: Cache not refreshing
# Comment says: "Cached for 5 minutes"
# Developer: "Wait 5 minutes and test"
# Still not refreshing
# Actual: 10 minutes
# Lost: 30 minutes debugging wrong assumption
```

**3. Erodes Trust**
```python
# After finding 3 stale comments
# Developer: "I can't trust any comments"
# Now ignores helpful comments too
# Documentation becomes worthless
```

**4. Causes Bugs**
```python
# Comment: "Thread-safe - uses lock"
def process_data(data):
    # Lock was removed during refactoring!
    # Comment not updated
    shared_resource.update(data)  # Race condition!

# Developer assumes thread-safe based on comment
# Introduces concurrency bugs
```

### Correct Approach

**Keep comments synchronized:**
```python
# ✅ UPDATE COMMENTS WITH CODE
def get_users():
    """
    Get users with pagination info.
    
    Returns:
        dict: {
            'users': List of user dicts,
            'count': Total user count,
            'page': Current page number
        }
    """
    return {"users": [...], "count": 10, "page": 1}

# Cache TTL: 10 minutes (600 seconds)
CACHE_TTL = 600
```

**Delete outdated comments:**
```python
# ❌ DON'T: Keep stale comment
# TODO: Add error handling (added 2020-01-15)
def process():
    try:
        operation()
    except Exception as e:
        handle_error(e)  # Error handling already added!

# ✅ DO: Delete when done
def process():
    try:
        operation()
    except Exception as e:
        handle_error(e)
```

**Prefer self-documenting code:**
```python
# ❌ COMMENT EXPLAINS UNCLEAR CODE
# Get first 3 characters
prefix = s[:3]

# ✅ CODE EXPLAINS ITSELF
prefix = filename[:3]  # or
filename_prefix = filename[:3]
```

### Prevention Strategies

**1. Review comments during code changes:**
```python
# Checklist when modifying function:
# [ ] Update function docstring
# [ ] Update parameter descriptions
# [ ] Update return value description
# [ ] Remove obsolete comments
# [ ] Verify remaining comments are accurate
```

**2. Prefer docstrings over comments:**
```python
# ✅ DOCSTRINGS - Visible in IDE, tested by tools
def calculate_discount(price: float, tier: str) -> float:
    """
    Calculate discount based on customer tier.
    
    Args:
        price: Original price in dollars
        tier: Customer tier ('basic', 'premium', 'vip')
        
    Returns:
        Discounted price in dollars
        
    Raises:
        ValueError: If tier is invalid
    """
    # Implementation
```

**3. Use type hints instead of comments:**
```python
# ❌ COMMENT FOR TYPES
# price: float, tier: str -> float
def calculate_discount(price, tier):
    pass

# ✅ TYPE HINTS - Enforced by tools
def calculate_discount(price: float, tier: str) -> float:
    pass
```

**4. Delete TODO comments when done:**
```python
# Search for old TODOs
grep -r "TODO.*20[0-9][0-9]" src/

# Either:
# - Complete the TODO and delete
# - Convert to issue tracker
# - Delete if no longer relevant
```

### Detection

```bash
# Find comment/code mismatches (manual review needed)
# Comments that mention old function names
grep -r "# .*old_function_name" src/

# Find very old TODOs/FIXMEs
grep -r "TODO.*201[0-9]" src/  # TODOs from 2010-2019
grep -r "FIXME.*201[0-9]" src/

# Find "temporary" code from years ago
grep -r "HACK\|TEMPORARY\|WORKAROUND" src/

# Check docstrings match function signatures
# Use tools like pydocstyle (Python)
pydocstyle src/
```

### Comment Quality Rules

**Good comments explain WHY:**
```python
# ✅ EXPLAINS WHY
# Use binary search instead of linear - list is always sorted
result = binary_search(data, target)

# Use exponential backoff to avoid overwhelming server
time.sleep(2 ** retry_count)

# Skip validation in test mode for faster iteration
if not test_mode:
    validate(data)
```

**Bad comments explain WHAT (code already shows):**
```python
# ❌ OBVIOUS COMMENT
# Increment counter
counter += 1

# Loop through items
for item in items:
    process(item)

# Return true
return True
```

**Self-documenting code reduces comment need:**
```python
# ❌ NEEDS COMMENT
# Check if user has permission
if u.r & 0x04:
    pass

# ✅ SELF-DOCUMENTING
if user.has_read_permission():
    pass
```

### Testing Documentation

```python
# ✅ TEST THAT DOCSTRINGS MATCH REALITY
import doctest

def calculate_total(items):
    """
    Calculate total cost.
    
    >>> calculate_total([{'price': 10, 'qty': 2}])
    20
    """
    return sum(item['price'] * item['qty'] for item in items)

# Run doctests
doctest.testmod()
```

---

## Related Topics

- **AP-25**: Undocumented Decisions - Related documentation issue
- **AP-22**: Inconsistent Naming - Related clarity issue

---

## Keywords

stale comments, outdated documentation, misleading comments, code evolution, docstrings, self-documenting code

---

## Version History

- **2025-10-30**: Created - Added detection methods and prevention strategies

---

**File:** `AP-26.md`  
**Lines:** ~200  
**End of Document**
