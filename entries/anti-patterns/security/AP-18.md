# AP-18.md - Logging Sensitive Data

**REF-ID:** AP-18  
**Version:** 1.0.0  
**Category:** Anti-Patterns  
**Topic:** Security  
**Priority:** üî¥ CRITICAL  
**Status:** Active  
**Created:** 2025-10-30  
**Last Updated:** 2025-10-30

---

## Summary

Logging sensitive data (passwords, tokens, PII) without redaction creates security and compliance risks. Logs are often stored insecurely, shared broadly, and retained long-term.

---

## Context

During debugging, developers log everything including sensitive fields. These logs get aggregated, stored, and accessed by many people, creating exposure risks and compliance violations.

**Problem:** Credential exposure, PII leaks, compliance violations (GDPR, HIPAA, PCI-DSS), security breaches.

---

## Content

### The Anti-Pattern

```python
# ‚ùå LOGGING SENSITIVE DATA
logger.info(f"User login: {username}, password: {password}")
logger.debug(f"API request: Authorization: Bearer {api_token}")
logger.info(f"Processing payment: card={card_number}, cvv={cvv}")
logger.debug(f"User data: {user_email}, SSN: {ssn}, DOB: {dob}")
```

### Why This Is Critical

**1. Log Aggregation**
```
Application logs ‚Üí
CloudWatch/Splunk/ELK ‚Üí
Accessible by entire ops team ‚Üí
Retained for months/years ‚Üí
Credentials exposed to many people
```

**2. Compliance Violations**
```
GDPR: Cannot log PII without consent/purpose
HIPAA: Cannot log PHI
PCI-DSS: Cannot log full card numbers, CVV
SOC 2: Must protect sensitive data in logs
```

**3. Third-Party Access**
```
Logs sent to monitoring services
Support staff review logs
Developers access production logs
Contractors may have log access
```

**4. Log Retention**
```
Logs retained 90 days to 7 years
Old credentials still in logs after rotation
PII persists beyond data retention policies
```

### What Is Sensitive

**Credentials (never log):**
- Passwords
- API keys, tokens, secrets
- Private keys
- Session IDs
- OAuth tokens
- Webhook secrets

**PII (redact or don't log):**
- Full names (use initials: J.D.)
- Email addresses
- Phone numbers
- Physical addresses
- IP addresses (GDPR considers PII)
- Social security numbers
- Driver's license numbers
- Passport numbers
- Biometric data

**Financial (strict rules):**
- Full credit card numbers (PCI-DSS)
- CVV codes (never log)
- Bank account numbers
- Tax IDs

**Health (HIPAA):**
- Medical record numbers
- Health insurance info
- Diagnoses, treatments
- Prescriptions

### Correct Approaches

**Redact completely:**
```python
# ‚úÖ COMPLETE REDACTION
logger.info(f"User login: {username}, password: [REDACTED]")
logger.debug(f"API request: Authorization: [REDACTED]")
logger.info(f"Processing payment: card=[REDACTED], cvv=[REDACTED]")
```

**Partial redaction:**
```python
# ‚úÖ PARTIAL REDACTION (show last 4 digits)
def redact_card(card_number):
    return f"****{card_number[-4:]}"

logger.info(f"Processing card: {redact_card(card_number)}")
# Output: "Processing card: ****1234"
```

**Hash sensitive data:**
```python
# ‚úÖ HASH FOR TRACKING (one-way)
import hashlib

def hash_pii(value):
    return hashlib.sha256(value.encode()).hexdigest()[:8]

user_hash = hash_pii(email)
logger.info(f"Processing user: {user_hash}")
# Output: "Processing user: a7f2b3c1"
# Can track same user without exposing email
```

**Redaction helpers:**
```python
# ‚úÖ REDACTION LIBRARY
def redact_email(email):
    """user@example.com ‚Üí u***@example.com"""
    if '@' not in email:
        return '[INVALID_EMAIL]'
    local, domain = email.split('@', 1)
    return f"{local[0]}***@{domain}"

def redact_phone(phone):
    """555-123-4567 ‚Üí ***-***-4567"""
    return f"***-***-{phone[-4:]}"

def redact_key(key):
    """sk-abc123def456 ‚Üí sk-***456"""
    return f"{key[:3]}***{key[-3:]}"

# Usage
logger.info(f"User: {redact_email(email)}, phone: {redact_phone(phone)}")
```

### Structured Logging

```python
# ‚úÖ STRUCTURED LOGGING WITH SENSITIVE FIELD MARKING
import logging
import json

class RedactingFormatter(logging.Formatter):
    SENSITIVE_FIELDS = {'password', 'token', 'api_key', 'secret'}
    
    def format(self, record):
        if hasattr(record, 'msg') and isinstance(record.msg, dict):
            sanitized = record.msg.copy()
            for field in self.SENSITIVE_FIELDS:
                if field in sanitized:
                    sanitized[field] = '[REDACTED]'
            record.msg = json.dumps(sanitized)
        return super().format(record)

# Usage
logger.info({'user': 'john', 'password': 'secret123', 'action': 'login'})
# Output: {"user": "john", "password": "[REDACTED]", "action": "login"}
```

### Detection

```bash
# Scan logs for sensitive patterns
grep -rE "(password|passwd|pwd|secret|token|api_key)\s*[:=]" logs/
grep -rE "\b\d{3}-\d{2}-\d{4}\b" logs/  # SSN pattern
grep -rE "\b\d{16}\b" logs/  # Credit card pattern
grep -rE "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" logs/  # Email

# Use automated scanners
git-secrets --scan  # Scan for secrets
gitleaks detect  # Find leaked credentials
```

### Testing Redaction

```python
# ‚úÖ TEST THAT SENSITIVE DATA IS REDACTED
def test_password_not_logged(caplog):
    login_user("john", "secret123")
    
    # Verify password not in logs
    for record in caplog.records:
        assert "secret123" not in record.message
        assert "[REDACTED]" in record.message

def test_email_redacted(caplog):
    process_user("user@example.com")
    
    # Verify full email not in logs
    for record in caplog.records:
        assert "user@example.com" not in record.message
        assert "@example.com" in record.message  # Domain ok
```

### Compliance Guidelines

**GDPR:**
- Minimize PII in logs
- Implement data retention policies
- Support right to erasure

**HIPAA:**
- No PHI in logs without encryption
- Access controls on log systems
- Audit log access

**PCI-DSS:**
- Never log full PAN (card number)
- Never log CVV/CVV2
- Mask PAN in logs (show last 4 only)
- Secure log storage and transmission

---

## Related Topics

- **AP-17**: Hardcoded Secrets - Related exposure risk
- **AP-19**: Sentinel Object Leaks - Unexpected data in logs

---

## Keywords

logging, sensitive data, PII, redaction, GDPR, HIPAA, PCI-DSS, compliance, security

---

## Version History

- **2025-10-30**: Created - Added compliance guidelines and redaction patterns

---

**File:** `AP-18.md`  
**Lines:** ~200  
**End of Document**
