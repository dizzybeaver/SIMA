# DT-09.md

**REF-ID:** DT-09  
**Category:** Decision Logic  
**Subcategory:** Testing  
**Name:** How Much to Mock  
**Priority:** Medium  
**Status:** Active  
**Created:** 2024-10-30  
**Updated:** 2024-10-30

---

## Summary

Decision tree for mocking strategies - determining appropriate mocking levels for unit tests (mock heavily), integration tests (mock selectively), and E2E tests (mock only external).

---

## Problem

Different test types require different mocking strategies. Unit tests need isolation, integration tests need authentic interactions, and E2E tests need realistic end-to-end flows.

---

## Mocking Strategy Matrix

| Test Type | Mock Level | What to Mock | What NOT to Mock |
|-----------|------------|--------------|------------------|
| Unit | Heavy | All dependencies | Nothing (full isolation) |
| Integration | Selective | External services only | Internal interfaces |
| E2E | Minimal | Remote APIs only | All internal components |
| Performance | None | Nothing | Mock degrades accuracy |

---

## Decision Tree

```
START: Writing test, need mocking
│
├─ Q: Testing single function in isolation?
│  ├─ YES → Mock dependencies heavily
│  │      Example: Mock all gateway calls
│  │      Pattern: Unit test
│  │      → END
│  │
│  └─ NO → Continue
│
├─ Q: Testing integration between components?
│  ├─ YES → Mock sparingly (only external)
│  │      Example: Mock only HTTP calls, not cache
│  │      Pattern: Integration test
│  │      → END
│  │
│  └─ NO → Continue
│
├─ Q: Testing end-to-end flow?
│  ├─ YES → Mock only external services
│  │      Example: Mock external API
│  │      Pattern: E2E test
│  │      → END
│  │
│  └─ NO → Continue
│
└─ Q: Testing performance/load?
   └─ YES → No mocking (real components)
          Example: Measure actual cache performance
          Pattern: Performance test
          → END
```

---

## Examples by Test Type

### Example 1: Unit Test - Mock Heavily

**Feature:** Test cache operation in isolation

**Strategy:** Mock all dependencies
```python
from unittest.mock import patch

def test_cache_operation_unit():
    """Unit test with heavy mocking."""
    with patch('gateway.log_info') as mock_log:
        with patch('gateway.record_metric') as mock_metric:
            # Test cache_set in complete isolation
            result = cache_set("key", "value")
            
            # Verify interactions
            mock_log.assert_called_once()
            mock_metric.assert_called_once()
            assert result == True
```

### Example 2: Integration Test - Mock Selectively

**Feature:** Test HTTP using cache

**Strategy:** Mock external HTTP only, keep cache real
```python
from unittest.mock import patch

def test_http_with_cache_integration():
    """Integration test with selective mocking."""
    # Mock only external HTTP call
    with patch('http_core.requests.get') as mock_http:
        mock_http.return_value.json.return_value = {"data": "value"}
        
        # Use REAL cache (not mocked)
        # First call - cache miss
        response1 = http_get_cached("https://api.example.com/data")
        
        # Second call - cache hit (no HTTP call)
        response2 = http_get_cached("https://api.example.com/data")
        
        # Verify cache worked
        assert response1 == response2
        mock_http.assert_called_once()  # Only called once due to cache
```

### Example 3: E2E Test - Mock Only External

**Feature:** Complete request flow

**Strategy:** Mock only remote APIs, all internal components real
```python
from unittest.mock import patch

def test_complete_request_flow():
    """E2E test with minimal mocking."""
    # Mock only external API
    with patch('external_api.call') as mock_api:
        mock_api.return_value = {"status": "success"}
        
        # All internal components REAL:
        # - Gateway routing
        # - Interface dispatch
        # - Core logic
        # - Caching
        # - Logging
        # - Metrics
        
        result = process_complete_request({
            "user_id": "123",
            "operation": "fetch_data"
        })
        
        assert result['success'] == True
        assert 'data' in result
```

### Example 4: Performance Test - No Mocking

**Feature:** Measure cache performance

**Strategy:** No mocks, measure real performance
```python
import time

def test_cache_performance_real():
    """Performance test with no mocking."""
    # NO MOCKS - test real cache performance
    gateway.cache_set("perf_key", "value")
    
    # Measure real operations
    start = time.time()
    for _ in range(1000):
        gateway.cache_get("perf_key")
    duration = time.time() - start
    
    # Verify real performance
    assert duration < 1.0  # Real constraint: <1ms per op
```

---

## Mocking Best Practices

### Unit Tests - Full Isolation

**Goal:** Test single function logic only

**Mock:**
- ✅ All gateway calls
- ✅ All external dependencies
- ✅ Database connections
- ✅ HTTP requests
- ✅ File I/O

**Don't Mock:**
- ❌ Built-in Python functions (usually)
- ❌ The function under test itself

```python
def test_process_user_data():
    """Unit test - mock everything."""
    with patch('gateway.cache_get') as mock_cache:
        with patch('gateway.log_info') as mock_log:
            with patch('gateway.http_get') as mock_http:
                mock_cache.return_value = None
                mock_http.return_value = {"user": "data"}
                
                # Test only process_user_data logic
                result = process_user_data("user123")
                
                assert result is not None
```

### Integration Tests - Authentic Interactions

**Goal:** Test components working together

**Mock:**
- ✅ External services (APIs, databases)
- ✅ Slow operations

**Don't Mock:**
- ❌ Internal interfaces
- ❌ Cache layer
- ❌ Logging
- ❌ Metrics

```python
def test_cache_and_http_integration():
    """Integration test - mock only external."""
    with patch('external_api.fetch') as mock_api:
        mock_api.return_value = "api_data"
        
        # REAL cache used
        # REAL logging used
        # REAL metrics used
        
        # First call - miss, fetches from API
        result1 = get_with_cache("key")
        
        # Second call - hit, uses cache
        result2 = get_with_cache("key")
        
        assert result1 == result2
        mock_api.assert_called_once()  # Cache worked!
```

---

## Anti-Patterns

### ❌ Over-Mocking in Integration Tests

**Problem:**
```python
def test_integration_bad():
    """BAD: Mocking internal components."""
    with patch('gateway.cache_get'):  # Wrong!
        with patch('gateway.cache_set'):  # Wrong!
            with patch('gateway.http_request'):
                # This isn't testing integration at all!
                result = http_get_cached("url")
```

**Solution:**
```python
def test_integration_good():
    """GOOD: Only mock external."""
    with patch('http_core.requests.get') as mock_http:
        # Cache is REAL
        # Gateway is REAL
        mock_http.return_value.json.return_value = {"data": "value"}
        
        result = http_get_cached("url")  # Tests real integration
```

### ❌ Under-Mocking in Unit Tests

**Problem:**
```python
def test_unit_bad():
    """BAD: Real dependencies in unit test."""
    # No mocking - not isolated!
    result = cache_set("key", "value")
    # If logging fails, test fails for wrong reason
```

**Solution:**
```python
def test_unit_good():
    """GOOD: Mock all dependencies."""
    with patch('gateway.log_info'):
        with patch('gateway.record_metric'):
            result = cache_set("key", "value")  # Fully isolated
```

### ❌ Mocking in Performance Tests

**Problem:**
```python
def test_performance_bad():
    """BAD: Mocking skews results."""
    with patch('gateway.cache_get', return_value="value"):
        # Measuring mock overhead, not cache performance!
        for _ in range(1000):
            gateway.cache_get("key")
```

**Solution:**
```python
def test_performance_good():
    """GOOD: No mocks, real performance."""
    gateway.cache_set("key", "value")  # Real cache
    
    # Measure real performance
    for _ in range(1000):
        gateway.cache_get("key")  # Real operations
```

---

## Related Patterns

**From NM04 (Decisions):**
- **DEC-18:** Test strategy decisions

**From NM07 (Decision Logic):**
- **DT-08:** What to test

---

## Keywords

mocking, mock strategy, test isolation, unit tests, integration tests, E2E tests, test dependencies

---

## Version History

- **2024-10-30:** Migrated to SIMAv4 format from NM07 v3
- **2024-10-24:** Created in SIMAv3 format

---

**File:** `DT-09.md`  
**Location:** `/sima/entries/decisions/testing/`  
**End of Document**
