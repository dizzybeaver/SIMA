# DT-03.md

**REF-ID:** DT-03  
**Category:** Decision Logic  
**Subcategory:** Feature Addition  
**Name:** User Wants Feature X  
**Priority:** High  
**Status:** Active  
**Created:** 2024-10-30  
**Updated:** 2024-10-30

---

## Summary

Decision tree for handling feature requests - determining if feature already exists, fits in existing interface, requires new interface, or belongs in utilities.

---

## Problem

When users request new functionality, first determine if it already exists. If not, choose correct location based on complexity, domain specificity, and architecture fit.

---

## Context

Gateway architecture supports 12+ interfaces. New features should extend existing interfaces when possible, create new interfaces when substantial (>200 lines + state + domain-specific), or use utility interface for simple helpers.

---

## Decision Tree

```
START: User requests feature X
│
├─ Q: Does X already exist in gateway?
│  ├─ YES → Point user to existing feature
│  │      Search: gateway_wrappers.py or documentation
│  │      Response: "Use gateway.function_name()"
│  │      → END
│  │
│  └─ NO → Continue
│
├─ Q: Does X fit in existing interface?
│  ├─ YES → Add to that interface
│  │      Example: cache.list_keys → CACHE interface
│  │      Steps:
│  │      1. Add to _OPERATION_DISPATCH in interface_<n>.py
│  │      2. Implement in <n>_core.py
│  │      3. Optional: Add wrapper in gateway_wrappers.py
│  │      → END
│  │
│  └─ NO → Continue
│
├─ Q: Is X substantial enough for new interface?
│  ├─ YES (>200 lines, has state, domain-specific)
│  │      → Create new interface
│  │      Steps:
│  │      1. Add to GatewayInterface enum
│  │      2. Create interface_<n>.py
│  │      3. Create <n>_core.py
│  │      4. Register in gateway_core.py
│  │      5. Add wrappers
│  │      6. Update documentation
│  │      → END
│  │
│  └─ NO (simple helper)
│         → Add to UTILITY interface
│         Steps:
│         1. Add to utility_core.py
│         2. Optional: Add to interface_utility dispatch
│         3. Optional: Add wrapper
│         → END
```

---

## Feature Decision Matrix

| Feature Characteristics | Location | Action |
|------------------------|----------|--------|
| Already exists | N/A | Point to existing |
| Fits existing interface | Existing interface | Extend interface |
| >200 lines + state + domain | New interface | Create interface |
| Simple helper (<50 lines) | Utility | Add to utilities |

---

## Examples

### Example 1: Feature Already Exists

**Request:**
"I need cache operations"

**Decision Process:**
1. Check gateway: `cache_get` exists → YES
2. **Action:** Point to existing

**Response:**
```python
# Feature already exists
from gateway import cache_get, cache_set, cache_delete

# Use existing functionality
value = cache_get("my_key")
cache_set("my_key", "my_value", ttl=300)
```

### Example 2: Extend Existing Interface

**Request:**
"Add cache.clear_expired() to remove old entries"

**Decision Process:**
1. Already exists? NO
2. Fits CACHE interface? YES (cache operation)
3. **Action:** Extend CACHE interface

**Implementation:**
```python
# 1. Add to interface_cache.py dispatch
_OPERATION_DISPATCH = {
    'get': _execute_get,
    'set': _execute_set,
    'delete': _execute_delete,
    'clear_expired': _execute_clear_expired,  # NEW
}

def _execute_clear_expired(parameters: Dict[str, Any]) -> Any:
    """Route clear_expired to core."""
    from cache_core import clear_expired_entries
    return clear_expired_entries()

# 2. Implement in cache_core.py
from gateway import log_info, get_current_time

def clear_expired_entries() -> int:
    """Remove expired cache entries.
    
    Returns:
        Number of entries removed
    """
    log_info("Starting cache expiration cleanup")
    current_time = get_current_time()
    removed = 0
    
    for key, entry in list(_CACHE_STORE.items()):
        if entry['expires_at'] < current_time:
            del _CACHE_STORE[key]
            removed += 1
    
    log_info(f"Removed {removed} expired entries")
    return removed

# 3. Add wrapper (optional)
def cache_clear_expired():
    """Clear expired cache entries."""
    return call_interface(
        interface=GatewayInterface.CACHE,
        operation='clear_expired'
    )
```

### Example 3: Create New Interface

**Request:**
"Add email sending capability"

**Decision Process:**
1. Already exists? NO
2. Fits existing? NO (no EMAIL interface)
3. Substantial? YES
   - >200 lines (SMTP logic, templates, retries)
   - Has state (SMTP connection, config)
   - Domain-specific (email operations)
4. **Action:** Create new EMAIL interface

**Implementation:**
```python
# 1. Add to GatewayInterface enum
class GatewayInterface(Enum):
    CACHE = "cache"
    LOGGING = "logging"
    # ... existing interfaces
    EMAIL = "email"  # NEW

# 2. Create interface_email.py
from typing import Dict, Any

_OPERATION_DISPATCH = {
    'send': _execute_send,
    'send_template': _execute_send_template,
    'validate_address': _execute_validate_address,
}

def route_operation(operation: str, parameters: Dict[str, Any]) -> Any:
    """Route email operations."""
    handler = _OPERATION_DISPATCH.get(operation)
    if not handler:
        raise ValueError(f"Unknown operation: {operation}")
    return handler(parameters)

def _execute_send(parameters):
    from email_core import send_email
    return send_email(
        to=parameters['to'],
        subject=parameters['subject'],
        body=parameters['body']
    )

# 3. Create email_core.py
from gateway import log_info, log_error, get_config
import smtplib

_SMTP_CONNECTION = None

def send_email(to: str, subject: str, body: str) -> bool:
    """Send email via SMTP.
    
    Returns:
        True if sent successfully
    """
    try:
        conn = _get_smtp_connection()
        # SMTP logic here (50+ lines)
        log_info(f"Email sent to {to}")
        return True
    except Exception as e:
        log_error(f"Failed to send email: {e}", error=e)
        return False

def _get_smtp_connection():
    """Get or create SMTP connection."""
    # Connection management logic
    pass

# 4. Register in gateway_core.py
_INTERFACE_ROUTERS = {
    GatewayInterface.CACHE: interface_cache.route_operation,
    GatewayInterface.LOGGING: interface_logging.route_operation,
    # ... existing
    GatewayInterface.EMAIL: interface_email.route_operation,  # NEW
}

# 5. Add wrappers
def email_send(to: str, subject: str, body: str):
    """Send email."""
    return call_interface(
        interface=GatewayInterface.EMAIL,
        operation='send',
        to=to,
        subject=subject,
        body=body
    )
```

### Example 4: Add to Utilities

**Request:**
"Add string.to_camel_case() conversion"

**Decision Process:**
1. Already exists? NO
2. Fits existing? NO (no STRING interface)
3. Substantial? NO (<20 lines, no state, generic)
4. **Action:** Add to UTILITY interface

**Implementation:**
```python
# In utility_core.py
def to_camel_case(text: str) -> str:
    """Convert string to camelCase.
    
    Args:
        text: Input string (snake_case or space-separated)
        
    Returns:
        camelCase string
        
    Examples:
        >>> to_camel_case('hello_world')
        'helloWorld'
        >>> to_camel_case('hello world')
        'helloWorld'
    """
    words = text.replace('_', ' ').split()
    if not words:
        return ''
    return words[0].lower() + ''.join(w.capitalize() for w in words[1:])

# Optional: Add wrapper
def utility_to_camel_case(text: str):
    """Convert to camelCase."""
    return call_interface(
        interface=GatewayInterface.UTILITY,
        operation='to_camel_case',
        text=text
    )
```

---

## Decision Flowchart

```
┌─────────────────────────────┐
│ User requests feature X     │
└──────────┬──────────────────┘
           │
           ▼
    ┌──────────────┐
    │ Already      │  YES ─► Point to existing
    │ Exists?      │           "Use gateway.X()"
    └──────┬───────┘
           │ NO
           ▼
    ┌──────────────┐
    │ Fits         │  YES ─► Extend interface
    │ Existing?    │           Add operation
    └──────┬───────┘
           │ NO
           ▼
    ┌──────────────┐
    │ Substantial? │  YES ─► Create new interface
    │ (>200 lines, │           Full implementation
    │ state,       │
    │ domain)      │
    └──────┬───────┘
           │ NO
           ▼
    ┌──────────────┐
    │ Simple       │  YES ─► Add to utilities
    │ Helper?      │           utility_core.py
    └──────────────┘
```

---

## Anti-Patterns

### ❌ Creating Interface for Simple Function

**Problem:**
```python
# Creating STRING interface for one 5-line function
class GatewayInterface(Enum):
    STRING = "string"  # Overkill!

# Just for:
def capitalize(text):
    return text.capitalize()
```

**Solution:**
```python
# Add to utility_core.py instead
def capitalize_text(text):
    return text.capitalize()
```

### ❌ Not Checking if Feature Exists

**Problem:**
```python
# Implementing cache_get from scratch
# when it already exists in gateway!
def my_cache_get(key):
    # Reimplementing existing functionality
    pass
```

**Solution:**
```python
# Use existing feature
from gateway import cache_get
value = cache_get(key)
```

---

## Related Patterns

**From NM01 (Interfaces):**
- **INT-01 to INT-12:** Existing interface patterns

**From NM04 (Decisions):**
- **DEC-01:** Gateway architecture choice
- **DEC-02:** Interface organization

**From NM07 (Decision Logic):**
- **DT-02:** Where should function go?
- **DT-13:** Should I create new interface?
- **DT-04:** Should this be cached?

---

## Keywords

feature addition, new feature, extend interface, create interface, user request, functionality

---

## Version History

- **2024-10-30:** Migrated to SIMAv4 format from NM07 v3
- **2024-10-24:** Created in SIMAv3 format

---

**File:** `DT-03.md`  
**Location:** `/sima/entries/decision-logic/feature-addition/`  
**End of Document**
