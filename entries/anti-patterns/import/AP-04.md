# File: AP-04.md

**REF-ID:** AP-04  
**Version:** 1.0.0  
**Category:** Anti-Patterns  
**Type:** Import Violations  
**Severity:** ðŸ"´ Critical  
**Status:** Active

---

## SUMMARY

Creating circular import loops even when using the gateway pattern correctly. The gateway prevents MOST circular dependencies, but violating dependency layer rules can still create import cycles.

---

## THE ANTI-PATTERN

### What NOT to Do

```python
# âŒ WRONG - Circular dependency through gateway

# In http_client_core.py (Layer 5: HTTP)
import gateway

def make_request(url):
    gateway.log_info(f"Requesting {url}")  # Layer 0 âœ…
    gateway.validate_url(url)  # Layer 7 (HIGHER!) âŒ
    # Problem: Layer 5 calling Layer 7

# In validation_core.py (Layer 7: VALIDATION)
import gateway

def validate_url(url):
    response = gateway.http_head(url)  # Back to Layer 5! âŒ
    # Circular: Layer 7 â†' Layer 5 â†' Layer 7
```

### Why It's Bad

1. **Import Deadlock** - Python cannot resolve circular dependencies
2. **Initialization Failure** - Module partially initialized causes AttributeError
3. **Unpredictable Behavior** - Order-dependent bugs
4. **Hard to Debug** - Error messages unclear about actual cause
5. **Architecture Violation** - Breaks dependency layer rules

---

## WHAT TO DO INSTEAD

### Correct Approach - Follow Dependency Layers

```python
# âœ… CORRECT - Respect dependency layers

# In validation_core.py (Layer 7: VALIDATION)
import gateway

def validate_url(url):
    # Only call SAME or LOWER layers
    gateway.log_debug(f"Validating {url}")  # Layer 0 âœ…
    
    # Don't call higher layers like HTTP
    # Use simple validation instead
    import re
    pattern = r'^https?://[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}'
    return bool(re.match(pattern, url))

# In http_client_core.py (Layer 5: HTTP)
import gateway

def make_request(url):
    # Validate before making request
    if not gateway.validate_url(url):  # âœ… Layer 5 â†' Layer 7 OK
        raise ValueError("Invalid URL")
    
    gateway.log_info(f"Requesting {url}")
    # Make request...
```

### Why This Is Better

- No circular dependency
- Clear layer hierarchy
- Predictable initialization
- Easier to debug
- Follows architectural rules

---

## DEPENDENCY LAYER RULES

### The 8 Layers

```
Layer 0: LOGGING (lowest, no dependencies)
Layer 1: METRICS
Layer 2: CONFIG
Layer 3: CACHE
Layer 4: SECURITY
Layer 5: HTTP
Layer 6: UTILITY
Layer 7: VALIDATION (highest in core)
Layer 8: GATEWAY (imports all, imported by none)
Layer 9: ROUTER (lambda_function.py)
```

### The Rule

**You can only call SAME or LOWER layers.**

```
âœ… ALLOWED:
    Layer 5 â†' Layer 3 (HTTP â†' CACHE)
    Layer 5 â†' Layer 0 (HTTP â†' LOGGING)
    Layer 7 â†' Layer 2 (VALIDATION â†' CONFIG)

âŒ NOT ALLOWED:
    Layer 3 â†' Layer 5 (CACHE â†' HTTP)
    Layer 0 â†' Layer 7 (LOGGING â†' VALIDATION)
    Layer 5 â†' Layer 7 (HTTP â†' VALIDATION)
```

---

## REAL-WORLD EXAMPLE

### Context

Cache validation calling back to cache - circular dependency.

### Problem Code

```python
# In cache_core.py (Layer 3)
import gateway

def get_value(key):
    # Validate key before getting
    if not gateway.validate_cache_key(key):  # Calls Layer 7!
        raise ValueError("Invalid key")
    return _cache_store.get(key)

# In validation_core.py (Layer 7)
import gateway

def validate_cache_key(key):
    # Check cache for known bad keys
    bad_keys = gateway.cache_get("bad_keys_list")  # Back to Layer 3!
    return key not in bad_keys
```

### What Went Wrong

```
ImportError: cannot import name 'cache_get' from partially initialized module 'gateway'
```

- Layer 3 (CACHE) â†' Layer 7 (VALIDATION) â†' Layer 3 (CACHE)
- Circular dependency caused import failure
- Lambda failed to initialize
- 100% error rate for 20 minutes

### Solution

```python
# In cache_core.py (Layer 3)
def get_value(key):
    # Simple validation without cross-layer call
    if not isinstance(key, str) or not key:
        raise ValueError("Invalid key")
    return _cache_store.get(key)

# In validation_core.py (Layer 7)
def validate_cache_key(key):
    # Don't call back to cache
    # Use simple rules
    return isinstance(key, str) and 0 < len(key) < 256
```

### Result

- No circular dependency
- Clean initialization
- Layer rules preserved
- System stable

---

## HOW TO IDENTIFY

### Code Smells

- Import errors mentioning "partially initialized module"
- AttributeError on gateway functions during import
- Initialization order problems
- Mysterious import failures in Lambda cold starts

### Detection Script

```python
# Check dependency layers
def check_layer_violations():
    layers = {
        'logging_core': 0,
        'metrics_core': 1,
        'config_core': 2,
        'cache_core': 3,
        'security_core': 4,
        'http_client_core': 5,
        'utility_core': 6,
        'validation_core': 7
    }
    
    for file, layer in layers.items():
        imports = get_gateway_calls(file)
        for imp in imports:
            imp_layer = layers.get(imp)
            if imp_layer and imp_layer > layer:
                print(f"VIOLATION: {file} (L{layer}) calls {imp} (L{imp_layer})")
```

---

## PREVENTION CHECKLIST

Before adding gateway call in core module:

- [ ] What layer is my current module?
- [ ] What layer is the function I'm calling?
- [ ] Am I calling same or lower layer only?
- [ ] If calling higher layer, can I restructure?
- [ ] Is this creating a circular dependency?

---

## IMPACT ANALYSIS

### System Impact

```
Circular import:
- 100% failure rate
- Complete system outage
- All Lambda invocations fail
- No graceful degradation possible

Resolution:
- Requires code deployment
- Cannot be fixed by restart
- MTTR: 15-30 minutes minimum
```

### Development Impact

```
Detection time: 0-60 minutes
Diagnosis time: 15-45 minutes
Fix time: 5-30 minutes
Testing time: 10-30 minutes
Total: 30-165 minutes per incident
```

---

## RELATED PATTERNS

### Must Read First
- **DEC-01** - SUGA Pattern
- **ARCH-01** - Gateway Trinity

### Related Rules
- **Dependency Layers** - DEP-01 through DEP-08

### Related Anti-Patterns
- **AP-01** - Direct Cross-Interface Imports
- **AP-05** - Importing from lambda_function

### Related Bugs
- **BUG-02** - Circular Import Crash (caused by this)

---

## DETECTION AND PREVENTION

### Automated Testing

```python
def test_no_circular_dependencies():
    """Verify no circular dependencies exist."""
    import importlib
    
    modules = [
        'logging_core', 'metrics_core', 'config_core',
        'cache_core', 'security_core', 'http_client_core',
        'utility_core', 'validation_core', 'gateway'
    ]
    
    for module in modules:
        try:
            importlib.import_module(module)
        except ImportError as e:
            if 'partially initialized' in str(e):
                pytest.fail(f"Circular dependency in {module}: {e}")
```

### Layer Validation

```bash
# Add to CI/CD pipeline
python -c "
from dependency_checker import validate_layers
violations = validate_layers()
if violations:
    print('Layer violations found:')
    for v in violations:
        print(f'  {v}')
    exit(1)
"
```

---

## MIGRATION GUIDE

### If You Find This Pattern

**Step 1:** Identify the circular dependency
```bash
# Run import test
python -c "import your_module"
# Note the error: "partially initialized module X"
```

**Step 2:** Map the dependency chain
```
Module A â†' calls gateway.function_b() â†' Module B
Module B â†' calls gateway.function_a() â†' Module A
Circular!
```

**Step 3:** Determine layer violations
```
Check layer of A and B
If A calls B and B calls A, one violates layers
```

**Step 4:** Restructure to follow layers
```python
# Option 1: Move functionality to lower layer
# Option 2: Remove circular call (use local logic)
# Option 3: Introduce new intermediate layer
```

**Step 5:** Test
```bash
python -c "import all_modules"  # Should succeed
```

---

## SEVERITY JUSTIFICATION

### Why Critical

1. **Complete System Failure** - All requests fail
2. **No Graceful Degradation** - Cannot run at all
3. **Deployment Required** - Cannot fix without code change
4. **Hard to Debug** - Error messages misleading
5. **High MTTR** - 30+ minutes to resolve

### Incident History

- **2025-10-18:** Circular import production outage (20 minutes)
- **2025-09-10:** Import failure in staging (caught before prod)
- **2025-08-15:** Partial initialization error (15 minutes)

**Total incidents:** 3 over 3 months  
**MTTR:** 20 minutes average  
**Prevention:** Strict layer adherence

---

## KEYWORDS

circular imports, dependency layers, import deadlock, initialization failure, layer violations, partially initialized module

---

## VERSION HISTORY

### [1.0.0] - 2025-10-30
- Migrated to SIMAv4 format
- Added layer violation detection
- Added prevention checklist
- Enhanced diagnosis methods

### [0.9.0] - 2025-10-23
- SIMA v3 individual file format

### [0.1.0] - 2024-10-15
- Initial documentation

---

**END OF ANTI-PATTERN ENTRY**

**Related:** AP-01, AP-05, BUG-02, DEC-01, ARCH-01, DEP-01 through DEP-08
